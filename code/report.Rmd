---
title: "Missing Data - Assignment 1"
author: "Aga, Nisse, Ruben"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 2
    df_print: kable
    highlight: tango
---

# Introduction 

# Methodology?

## Data

Description of the dataset source and variables selection.

##

# Loading data

We first specify our dependencies and read the data from the `data.rds` file.
```{r import dependencies, message = FALSE, warning = FALSE}
library(tidyverse)
library(fastDummies)
library(kableExtra)
library(gridExtra, exclude="combine")
library(lubridate)
library(car)
library(ICC)
library(caret)
library(pROC)
library(naniar)
library(ggmice)
library(mice)
```

```{r load data}
source <- readRDS("../data/data.rds") %>%
  as_tibble()
```

We then create a sub-selection of variables that are of interest to our model.

```{r variable selection}
data <- source %>%
  select(
    id,
    drink_regularly, 
    sex, 
    age,
    ethnicity, 
    education, 
    marital, 
    household_income,
    dep1,
    dep2,
    dep3,
    dep4,
    dep5,
    dep6,
    dep7,
    dep8,
    dep9
  )
```

## Variables description

```{r variable table, echo=FALSE}
read.csv("../data/variables.csv", header = TRUE, sep = ";") %>%
  as_tibble() %>%
  kable(
    # caption="Table with variable information."
    )
```

The table above lists the variables used in our subset selection, which will be utilised for the model in question. The predictor variables $[dep1...dep9]$ are sourced from the same Depression Screener, where respondents of age 18 to 150 were ought to assign a number (1 to 3) regarding their mental and physical state within the last 2 weeks. 
The demographic variables - that being `sex`, `age`, `ethnicity`, `education` and `household_income` - were taken from the same screening component as well. The following should be noted, regarding these demographic variables:  

- The variable `age` is topcoded at the value `80`  for the respondents who were older than 80 years. 
- The variable `education` was targeted at respondents of age `20` to `150`, thus excluding younger participants. This is due to the fact that this question includes responses such as `AA degree` and `College Graduate`.
- Similarly, the variable `marital` was also targeted at respondents of age `20` to `150`.
- The variable `household_income` is ordinal, rather than continuous.

As for the remaining demographic variables, namely `sex`, `age`, `ethnicity` and `household_income`, these are retrieved from target age `0` to `150`.  

Finally, the `drink_regularly` variable was obtained from a an Alcohol Use questionnaire targeted at ages 20 and up.


# EDA

## Descriptive statistics

```{r data summary}
summary(data)


n_rows <- n_distinct(data$id)
```

Notes:  
- note: age < 20 is missing from data!!  
- `r n_rows` unique rows / cases.  

## Distributions

```{r dist}

# Continuous
ggplot(data, aes(age)) + geom_histogram(stat = 'count')

# Categorical
categorical_dist <- function(plot) {
  plot +
    geom_histogram(stat = 'count') +
     theme(axis.text.x = element_blank())
}

ggplot(data, aes(drink_regularly, fill = drink_regularly)) %>% categorical_dist()
ggplot(data, aes(sex, fill = sex)) %>% categorical_dist()
ggplot(data, aes(ethnicity, fill = ethnicity)) %>% categorical_dist()
ggplot(data, aes(education, fill = education)) %>% categorical_dist()
ggplot(data, aes(marital, fill = marital)) %>% categorical_dist()
ggplot(data, aes(household_income, fill = household_income)) %>% categorical_dist()

# TODO depression data

```
Notes:  
- Age is not normally distributed, moreover might be unknowingly missing data < 20 and > 70?  
- Missing data in outcome (and depression).  
- Lots of married people compared to other marital statuses.

## Outliers

Can only check continuous variables, hence only `age`.

```{r outlier plots}
ggplot(data, aes(age)) +
  geom_boxplot()
```
No outliers using IQR.

## Relations

```{r correlation plots}
```




## Missing data and response Patterns
Firstly, we investigate the overall distribution of missing data in our dataset:

```{r mis_percentage}

# Creates a graph displaying the % of data missing in each variable

vis_miss(data)
```

As can be seen on the graph above, 8.2% of the data is missing. The missing values occur in the outcome variable 'drink_regularly' and in the responses to questions 'dep2', 'dep3', 'dep5' and 'dep6'that create the depression score variable. 15% of responses are missing for the predictor variable and 25% of the responses are missing for the individual depression questions. 

We further investigate the missing data patterns by looking at the response patters:

```{r res_pattern}

#Creates a graph with all of the response patterns in the dataset and their frequency

md.pattern(data, rotate = TRUE)
```

This figure reveals that there are four distinct response patterns in the dataset. The most frequent one is no missing entries, with 340 cases. Alternatively, either all four depression entries are missing (106 cases), the predictor variable is missing (54 cases) or both (25 cases). It is very probable that the reason for item non-response for the depression items is the same, since there are no cases of only some of them missing. Since the depression items are missing in this pattern, 25% of the overall depression score will be missing. 

#### Testing dependency of missing values

```{r is_mis_vectors}
# Creating vectors that indicate if a value is missing in a given variable. Since the pattern in depression items is the same, one vector is sufficient. 

mdrink <- is.na(data$drink_regularly)
mdep <- is.na(data$dep2)

# Testing dependency between missing value in var1 and values of var2. Null hypothesis: no dependency. 

out1 <- t.test(age ~ mdrink, data = data)
out1$statistic
out1$p.value
```

```{r mcar_test}
# Should this be on data1 or data?
mcar_test(data)
```
Thus, the missing values are definitelly not missing at random. 


