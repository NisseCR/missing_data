---
title: "Missing Data - Assignment 1"
author: "Aga, Nisse, Ruben"
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2
---

```{r import dependencies, message = FALSE, warning = FALSE, echo = FALSE}
# We first specify our dependencies and read the data from the `data.rds` file.
library(tidyverse)
library(fastDummies)
library(kableExtra)
library(gridExtra, exclude="combine")
library(lubridate)
library(car)
library(ICC)
library(caret)
library(pROC)
library(naniar)
library(ggmice)
library(mice)
library(Hmisc)
library(vtable)
library(vcd)
```

```{r helper-functions, echo=FALSE}
show_table <- function(data, caption, scale = TRUE) {
  if (scale) {
    args <- c("striped", "scale_down", "hold_position", "repeat_header")
  } else {
    args <- c("striped", "hold_position", "repeat_header")
  }
  
  kbl(data, caption = caption, booktabs = T) %>%
    kable_styling(latex_options = args)
}
```

```{r load data, echo = FALSE}
source <- readRDS("../data/data.rds") %>%
  as_tibble()
```

```{r variable-selection, echo=FALSE}
# We create a sub-selection of variables that are of interest to our model.
data <- source %>%
  select(
    id,
    drink_regularly, 
    sex, 
    age,
    ethnicity, 
    education, 
    marital, 
    household_income,
    dep1,
    dep2,
    dep3,
    dep4,
    dep5,
    dep6,
    dep7,
    dep8,
    dep9
  )
```

# Introduction (Ruben)

### RQ (Ruben)
Alcohol consumption led to 2.8 million deaths in 2016 and accounts for almost 10% of global deaths in people aged 15-49 years. Higher levels of alcohol consumption leads to a higher risk of mortality and the only level of alcohol consumption that minimizes this risk is zero alcohol consumption (study). This means that drinking any alcohol at all increases the risk of mortality. All of this makes it vital to know and understand the factors behind alcohol consumption.

Moore et al. 2005 found that age, sex, ethnicity, marital status, education level and household income were all either negatively or positively associated with alcohol consumption. In Garnett et all. 2022 it was found that the level of depression was negatively associated with alcohol consumption. Considering that the only safe level of alcohol consumption is zero, it is important to understand what factors predict regular consumption of alcohol instead of only looking at the amount of alcohol consumption as in the two studies mentioned above. 

The research question of this study is whether the occurrence of regular alcohol consumption (12 or more in a year) can be predicted by the variables: depression level, age, sex, ethnicity (white vs other), marital status and household income. It is expected that age and depression level will be negatively correlated with the occurrence of alcohol consumption while household income will be positively correlated (sources). It is also expected that being male (vs female) and white ( vs other ethnicities) will be positively correlated with the regular occurrence of alcohol consumption (source). Regarding marital status it is expected that the married status will be positively associated with the regular occurrence of alcohol consumption compared to others but that is based on a study where the factor marital status consisted of just married and other (source), while in this study more categories are considered.

# Methodology (Aga)

## Dataset

The dataset used is a subset of the data collected in the National Health and Nutrition Examination Survey (NHANES). The survey is a part of annual program that investigates the health and nutrition of  a representative sample of people in the United States. The data we used contains information about 525 individuals that has been collected for the NHANES 2007-2008. This is a subset of the 12,946 individuals in that years' survey sample, out of which 78.4% was interviewed and 75.4% was examined in mobile examination centers. The NHANES is further subdivided into themed sections, such as the Alcohol Use questionnaire, that have separate documentation that will be refered to later. 

The used dataset contains a wide range of variables related, to the health of the individuals. We further subset the data by only including variables relevant to the study (demographics, alcohol use and answers to depression screener questions). The selected variables are further described in Variable Description section.  

# Methodology (Aga) {#methodology}

## Dataset

The dataset used is a subset of the data collected in the National Health and Nutrition Examination Survey (NHANES). The survey is a part of annual program that investigates the health and nutrition of a representative sample of people in the United States. The data we used contains information about 525 individuals that has been collected for the NHANES 2007-2008. This is a subset of the 12,946 individuals in that years' survey sample, out of which 78.4% was interviewed and 75.4% was examined in mobile examination centers. 

The used dataset contains a wide range of variables related to the health of the individuals. We further subset the data by only including variables relevant to the study (demographics, alcohol use and answers to depression screener questions). The selected variables are further described in Variable Description section.  

## Data variables

```{r, vars-desc, echo = FALSE}
# Read variable description file.
descs <- read.csv("../data/variables.csv", header = TRUE, sep = ";") %>%
  as_tibble()
show_table(descs, "Variable descriptions")
```

Table \@ref(tab:vars-desc) lists the variables used in our subset selection, which will be utilised for the model in question. 
The predictor variables $[dep1...dep9]$ are sourced from the same Depression Screener, where respondents of age 18 to 150 were ought to assign a number (1 to 3) regarding their mental and physical state within the last 2 weeks. Multiple signs of depression were measured this way, which can later be combined to indicate an overall level of depression.

The demographic variables - that being `sex`, `age`, `ethnicity`, `education` and `household_income` - were taken from the same screening component as well. The following should be noted, regarding these demographic variables:  

- The variable `age` is topcoded at the value `80`  for the respondents who were older than 80 years. 
- The variable `education` was targeted at respondents of age `20` to `150`, thus excluding younger participants. This is due to the fact that this question includes responses such as `AA degree` and `College Graduate`.
- Similarly, the variable `marital` was also targeted at respondents of age `20` to `150`.
- The variable `household_income` is ordinal, rather than continuous.  

As for the remaining demographic variables, namely `sex`, `age`, `ethnicity` and `household_income`, these are retrieved from target age `0` to `150`.  

Finally, the `drink_regularly` variable was obtained from an Alcohol Use questionnaire targeted at ages 20 and up.

## Data processing methodology

### Data proccessing methodology
After arriving at the subset dataset, as Exploratory Data Analysis was performed. The distributions of the variables were investigated and presence of missing data was found in the outcome variable and some of the depression questions. The important findings of this step are presented in 'EDA Results' section. 

Following the EDA, the missing data problem was addressed. The extend, distribution and patterns of missingness were investigated. Testing was done to verify the missing data mechanism, including testing of the dependencies between missing values in one variable and observed values of other variables and performing the Little (1988) MCAR Test. 

Two solutions to the missing data problem were implemented: list-wise deletion and mean imputation. These where chosen based on the convenience of implementation. For list-wise deletion all cases with one or more missing values were excluded from the modeling. The mean imputation method was implemented in the following way: For the missing depression questions the mean of the observed values within the variable was computed and then the missing values were replaces by the mean value. For 'drink_regularly, the outcome variable, instead of a mean, the mode was computed. This was motivated by the need for a binary outcome variable in the logistic regression that was planned to answer the research question. Since the EDA found there was significantly more 'yes' values than 'no' values in 'drink_regularly', the missing values were replaces by 'yes'. Thus, two complete datasets with diffrent missing data treatments were created.

### Model methodology
Including all of the variables in the two complete data sets is motivated by theoretical findings since other researchers found a relationship between them and drinking habits. Therefore, verifying the significance of these predictors and their relative importance in the presence of other variables was important. Thus, a decision was made to create two logistical models including all of the variables, instead of a top down or bottom up approach to model building. As opposed to removing the non-significant predictors as in the other approaches, we decided to keep them and therefore have more complex models. 

The two logistics models were then compared and the impact of the two different missing data treatments was eveluated.  

- what we investigated and why

# EDA Results (Nisse) {#EDA}

## Descriptive statistics {#desc-stats}

```{r data-calcs, echo=FALSE}
# Calculate frequency per marital category, excluding the dominant category of 'married'.
marital_counts <- data %>%
  select(marital) %>%
  filter(marital != 'married') %>%
  group_by(marital) %>%
  count()
  
# Calculate mean frequency of non-dominant marital categories.
marital_avg <- mean(marital_counts$n)

# Function for marital plotting
plot_marital <- function(data) {
  ggplot(data, aes(marital)) +
    geom_bar(stat = 'count') +
    labs(
      x = 'Marital status',
      y = 'Frequency'
    )
}
```
Table \@ref(tab:data-sum) from the appendix shows summary statistics for each of the variables within the dataset; including mean values, standard deviations, IQR statistics and data range values. For categorical variables, a list of possible categories and their respective proportions is provided to replace the continuous summary statistics. Lastly, the column `N` shows the amount of cases with present  data - that being non-NA values.  
In general, it is worthy to note that all variables are interpreted as a factor, excluding `age` and the multiple depression levels of `dep`. Table \@ref(tab:vars-desc) suggests that `dep` should in fact be categorical ordinal and should therefore be cast as a factor. That said - and as mentioned in Section \@ref(methodology) - keeping the levels of `dep` as a numerical continuous datatype is beneficial for our missing data problem.  

Our dichotomous outcome variable `drink_regularly` has 307 cases of "yes" and 107 cases of "no", having a outcome balance of 69% and 31% respectively. This outcome ratio could be considered imbalanced, which could affect the accuracy of our logistic regression model. Additionally, the total amount of value entries (`N`) of 446 suggests that 79 cases contain values outside of the set of possible binary values - most likely being missing values. Table \@ref(tab:drink-missing) further confirms this.  

```{r, drink-missing, echo=FALSE}
data %>%
  count(drink_regularly) %>%
  show_table("Drink regularly value distributions", scale = FALSE)
```

Predictor `sex` is a dichotomous variable with a balanced frequency distribution across the values "male" and "female", that being 48% and 52% respectively. 525 entries contain one of these values, suggesting that the variable does not contain missing data.  

The predictor `age` is the only continuous variable present within the sub-selected dataset. Although the survey was targeted at respondents of age 0-150 for most variables - the documentation even mentioning the topcoded entries for age 80+ - the dataset seems to only contain cases of people between the age of 20 and 69. Moreover, Figure \@ref(fig:age-dist) suggests a uniform distribution of the age variable.
Like `sex`, `age` has 525 cases with non-NA values, hence the variable does not contain missing data values.

```{r age-dist, fig.cap = "Distribution of age", echo=FALSE, warning=FALSE}
ggplot(data, aes(age)) +
  geom_histogram(stat = 'count')
```

Predictor `ethnicity` has 5 categories, with `non-hispanic_white` being the most prevalant category with 220 cases (42% of total), all the while `other` is the most infrequent category with 25 cases (5%). A total of 525 cases contain `ethnicity` data, once again suggesting no presence of missing data values within this variable.  

Predictor `education` is similar to `ethnicity`, having 5 categories. That said, the frequencies of said categories seem to be less out of proportion, with `some_college` being the most frequent category with 155 (30%) cases. Whilst the data was retrieved from respondents of ages 20 and higher, we do not observe any missing data values within the variable. This can be further justified by the fact that the minimum `age` within our dataset is 20, therefore foregoing possible issues with younger participants being unable to provide data for this specific variable.

The predictor variable `marital` contains 6 categories. Prior to combining the `marital` categories, the category value `married` exceeded the the average frequency of other categories (that being `r marital_avg`) by a large margin - as can be seen in Figure \@ref(fig:marital-dist-1). Specifically, 279 cases (53%) were `married`, with the other 5 categories made up the remaining 47% of the cases. `never_married` was the most frequent among those other 5 categories with 102 (19%) cases, whilst `separated` was the most infrequent category with only 14 (3%) cases.  


```{r marital-dist-1, fig.cap = "Distribution of marital status categories before pre-processing", echo = FALSE}
plot_marital(data)
```

## Correlations

```{r cont-marital, echo = FALSE}
cont_mar <- table(data$marital, data$drink_regularly)
show_table(cont_mar, "Contigency table of marital vs. drink regularly", scale = FALSE)
```

```{r sign-marital, echo = FALSE}
chisq.test(data$marital, data$drink_regularly)
assocstats(xtabs(~data$marital + data$drink_regularly))
```

TODO (from pract):  

- Variable with most NA's
- Summary of non-NA vars
- 

## Outliers

For our only continuous predictor `age`, a boxplot shows potential outliers if datapoints fall outside of the interquartile range (whiskers of the plot). Figure \@ref(fig:age-outliers) shows the distribution of `age` in said boxplot, revealing no possible outliers. This is to be expected, since `age` was uniformly distributed as mentioned in Section \@ref(desc-stats).

```{r age-outliers, fig.cap = "Boxplot of age", echo=FALSE}
ggplot(data, aes(age)) +
  geom_boxplot()
```
As for our categorical predictors,

```{r combine-marital, echo=FALSE}
data <- data %>%
  mutate(marital = case_when(
    marital == 'married' ~ 'married',
    .default = 'other'
  ))
```

Figure \@ref(fig:marital-dist-2) shows the frequencies per `marital` category after the pre-processing step of combining the other values into one.

```{r marital-dist-2, fig.cap = "Distribution of marital status categories after pre-processing", echo=FALSE}
plot_marital(data)
```

# Missing data problem (Aga)

## Missing data and response Patterns
Firstly, we investigate the overall distribution of missing data in our dataset:

```{r mis_percentage, echo = FALSE}

# Creates a graph displaying the % of data missing in each variable
vis_miss(data)
```

As can be seen on the graph above, 8.2% of the data is missing. The missing values occur in the outcome variable 'drink_regularly' and in the responses to questions 'dep2', 'dep3', 'dep5', 'dep6', 'dep8' and 'dep9' that create the depression score variable. 15% of responses are missing for the predictor variable. 25% of the responses are missing for the individual depression questions 2, 3, 5 and 6, 10% are missing for question 8 and 14% for question 9. 

We further investigate the missing data patterns by looking at the response patters:

```{r res_pattern, echo = FALSE}
# Creates a graph with all of the response patterns in the dataset and their frequency
md.pattern(data, rotate = TRUE)
```

This figure reveals that there are 13 distinct response patterns in the dataset and the missingness pattern is not monotone. The most frequent pattern is no missing entries, with 263 cases. It is important to note that the depression questions 2, 3, 5 and 6 are always either all present or all missing. It is very probable that the reason for item non-response for the depression items is the same, since there are no cases of only some of them missing. 

Based on the missingness pattern of the depression items, 41% of the overall depression score includes at least one missing value. 

#### Testing dependency of missing values

```{r is_mis_vectors, echo = FALSE}
# Creating vectors that indicate if a value is missing in a given variable. Since the pattern in depression items is the same, one vector is sufficient. 

mdrink <- is.na(data$drink_regularly)
mdep <- is.na(data$dep2)

# Testing dependency between missing value in var1 and values of var2. Null hypothesis: no dependency. 

out1 <- t.test(age ~ mdrink, data = data)
out1$statistic
out1$p.value
```

```{r mcar_test, echo = FALSE}
# Should this be on data1 or data?
mcar_test(data)
```
Thus, the missing values are definitely not missing at random. 

- what's the missing data mechnism? 

### Result models with deletion and imputation (Nisse)
- formula
- table with coefficients and pval (make sure to exponential the coefficients for easier interpretation)
- Interpretation of model result 

```{r}
miceOut <- mice(data, defaultMethod = c("norm.predict", "logreg", "polyreg", "polr"), m = 1, maxit = 1)
reg_imp_data <- complete(miceOut)
summary(reg_imp_data)
```

## Model creation (maybe combine with next section?)

Mostly code for now, will add more later on.  

TODO:  

- Use mode imputation for depression and outcome.
- Mention n rows removal in case of listwise

Summary of code:  
1. Create imputed data for each ad-hoc method.
2. combine deps levels for each dataset.
3. create models for analysis.

```{r combine-dep, echo = FALSE}
# Combine imputed levels of depression into one depression score.
combine_dep <- function(data) {
  data %>%
    mutate(dep = dep1 + dep2 + dep3 + dep4 + dep5 + dep6 + dep7 + dep8 + dep9) %>%
    select(-c(dep1, dep2, dep3, dep4, dep5, dep6, dep7,  dep8, dep9))
}
```

```{r mean-imp, echo = FALSE, warning = FALSE}
# Perform mean imputation on the data. Mode imputation is used for drink_regularly.

# Copy data
data_mi <- data

# Mode imputation for drink_regularly.
data_mi$drink_regularly <- impute(data_mi$drink_regularly, fun = mode)

# Mean imputation for depression levels.
data_mi <- mice(data_mi, method = "mean", m = 1, maxit = 1) %>%
  complete()

# Combine depression levels.
data_mi <- combine_dep(data_mi)

# Check if imputation works.
md.pattern(data_mi)
```

```{r lw-del, echo = FALSE}
# Perform listwise deletion on the data.
data_lw <- data[complete.cases(data), ]

# Combine depression levels.
data_lw <- combine_dep(data_lw)

# Check if imputation works.
md.pattern(data_mi)
```

```{r model-creation, echo = FALSE}
# Listwise deletion model creation.
fit_lw <- glm(
  drink_regularly ~ sex + age + ethnicity + education + marital + household_income + dep, 
  family = binomial, 
  data = data_lw
)

# Mean imputation model creation.
fit_mi <- glm(
  drink_regularly ~ sex + age + ethnicity + education + marital + household_income + dep, 
  family = binomial, 
  data = data_mi
)
```

## Comparison of the two diffrent models in terms of missing data treatment !!! (Ruben)

## Conclusion in terms of answering RQ (Nisse)

# Appendix {#appendix}

```{r data-sum, echo=FALSE}
sumtable(data, title = "Summary statistics", fit.page = TRUE)
```

