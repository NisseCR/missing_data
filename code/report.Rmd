---
title: "Missing Data - Assignment 1"
author: "Aga, Nisse, Ruben"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 2
    df_print: kable
    highlight: tango
---

# Introduction (Ruben)

### RQ (Ruben)
Alcohol consumption led to 2.8 million deaths in 2016 and accounts for almost 10% of global deaths in people aged 15-49 years. Higher levels of alcohol consumption leads to a higher risk of mortality and the only level of alcohol consumption that minimizes this risk is zero alcohol consumption (study). This means that drinking any alcohol at all increases the risk of mortality. All of this makes it vital to know and understand the factors behind alcohol consumption.

Moore et al. 2005 found that age, sex, ethnicity, marital status, education level and household income were all either negatively or positively associated with alcohol consumption. In Garnett et all. 2022 it was found that the level of depression was negatively associated with alcohol consumption. Considering that the only safe level of alcohol consumption is zero, it is important to understand what factors predict regular consumption of alcohol instead of only looking at the amount of alcohol consumption as in the two studies mentioned above. 

The research question of this study is whether the occurrence of regular alcohol consumption (12 or more in a year) can be predicted by the variables: depression level, age, sex, ethnicity (white vs other), marital status and household income. It is expected that age and depression level will be negatively correlated with the occurrence of alcohol consumption while household income will be positively correlated (sources). It is also expected that being male (vs female) and white ( vs other ethnicities) will be positively correlated with the regular occurrence of alcohol consumption (source). Regarding marital status it is expected that the married status will be positively associated with the regular occurrence of alcohol consumption compared to others but that is based on a study where the factor marital status consisted of just married and other (source), while in this study more categories are considered.

# Methodology (Aga)

## Dataset

The dataset used is a subset of the data collected in the National Health and Nutrition Examination Survey (NHANES). The survey is a part of annual program that investigates the health and nutrition of  a representative sample of people in the United States. The data we used contains information about 525 individuals that has been collected for the NHANES 2007-2008. This is a subset of the 12,946 individuals in that years' survey sample, out of which 78.4% was interviewed and 75.4% was examined in mobile examination centers. The NHANES is further subdivided into themed sections, such as the Alcohol Use questionnaire, that have separate documentation that will be refered to later. 

The used dataset contains a wide range of variables related, to the health of the individuals. We further subset the data by only including variables relevant to the study (demographics, alcohol use and answers to depression screener questions). The selected variables are further described in Variable Description section.  

```{r import dependencies, message = FALSE, warning = FALSE, echo = FALSE}
# We first specify our dependencies and read the data from the `data.rds` file.
library(tidyverse)
library(fastDummies)
library(kableExtra)
library(gridExtra, exclude="combine")
library(lubridate)
library(car)
library(ICC)
library(caret)
library(pROC)
library(naniar)
library(ggmice)
library(mice)
```

```{r load data, echo = FALSE}
source <- readRDS("../data/data.rds") %>%
  as_tibble()
```

## Variables description


```{r variable selection, echo = FALSE}
# We then create a sub-selection of variables that are of interest to our model.
data <- source %>%
  select(
    id,
    drink_regularly, 
    sex, 
    age,
    ethnicity, 
    education, 
    marital, 
    household_income,
    dep1,
    dep2,
    dep3,
    dep4,
    dep5,
    dep6,
    dep7,
    dep8,
    dep9
  )
```

The table below lists the variables used in our subset selection, which will be utilized for the model in question. The predictor variables $[dep1...dep9]$ are sourced from the same Depression Screener, where respondents of age 18 to 150 were ought to assign a number (1 to 3) regarding their mental and physical state within the last 2 weeks. These questions are intended as components of an overall Depression Score that will be created by summing up the individual values.  
The demographic variables - that being `sex`, `age`, `ethnicity`, `education` and `household_income` - were taken from the same screening component as well. The following should be noted, regarding these demographic variables:  

- The variable `age` is topcoded at the value 80  for the respondents who were older than 80 years. 
- The variable `education` was targeted at respondents of age 20 to 150, thus excluding younger participants. It is likely due to the fact that it intends to register the "final" level of education and participats would not be likely to accomplish `AA degree` or `College Graduate` earlier.
- Similarly, the variable `marital` was also targeted at respondents of age 20 to 150.
- The variable `household_income` is ordinal, rather than continuous.

As for the remaining demographic variables, namely `sex`, `age`, `ethnicity` and `household_income`, these are retrieved from target age 0 to 150.  

Finally, the `drink_regularly` variable was obtained from a an Alcohol Use questionnaire targeted at ages 20 and up.

```{r variable table, echo=FALSE}
read.csv("../data/variables.csv", header = TRUE, sep = ";") %>%
  as_tibble() %>%
  kable(
    # caption="Table with variable information."
    )
```


### Data proccessing methodology
After arriving at the subset dataset, as Exploratory Data Analysis was performed. The distributions of the variables were investigated and presence of missing data was found in the outcome variable and some of the depression questions. The important findings of this step are presented in 'EDA Results' section. 

Following the EDA, the missing data problem was addressed. The extend, distribution and patterns of missingness were investigated. Testing was done to verify the missing data mechanism, including testing of the dependencies between missing values in one variable and observed values of other variables and performing the Little (1988) MCAR Test. 

Two solutions to the missing data problem were implemented: list-wise deletion and mean imputation. These where chosen based on the convenience of implementation. For list-wise deletion all cases with one or more missing values were excluded from the modeling. The mean imputation method was implemented in the following way: For the missing depression questions the mean of the observed values within the variable was computed and then the missing values were replaces by the mean value. For 'drink_regularly, the outcome variable, instead of a mean, the mode was computed. This was motivated by the need for a binary outcome variable in the logistic regression that was planned to answer the research question. Since the EDA found there was significantly more 'yes' values than 'no' values in 'drink_regularly', the missing values were replaces by 'yes'. Thus, two complete datasets with diffrent missing data treatments were created.

### Model methodology
Including all of the variables in the two complete data sets is motivated by theoretical findings since other researchers found a relationship between them and drinking habits. Therefore, verifying the significance of these predictors and their relative importance in the presence of other variables was important. Thus, a decision was made to create two logistical models including all of the variables, instead of a top down or bottom up approach to model building. As opposed to removing the non-significant predictors as in the other approaches, we decided to keep them and therefore have more complex models. 

The two logistics models were then compared and the impact of the two different missing data treatments was eveluated.  

# EDA Results (Nisse)

## Descriptive statistics

```{r data summary}
summary(data)


n_rows <- n_distinct(data$id)
```

Notes:  
- note: age < 20 is missing from data!!  
- `r n_rows` unique rows / cases.  

## Distributions

```{r dist}

# Continuous
ggplot(data, aes(age)) + geom_histogram(stat = 'count')

# Categorical
categorical_dist <- function(plot) {
  plot +
    geom_histogram(stat = 'count') +
     theme(axis.text.x = element_blank())
}

ggplot(data, aes(drink_regularly, fill = drink_regularly)) %>% categorical_dist()
ggplot(data, aes(sex, fill = sex)) %>% categorical_dist()
ggplot(data, aes(ethnicity, fill = ethnicity)) %>% categorical_dist()
ggplot(data, aes(education, fill = education)) %>% categorical_dist()
ggplot(data, aes(marital, fill = marital)) %>% categorical_dist()
ggplot(data, aes(household_income, fill = household_income)) %>% categorical_dist()

# TODO depression data

```
Notes:  
- Age is not normally distributed, moreover might be unknowingly missing data < 20 and > 70?  
- Missing data in outcome (and depression).  
- Lots of married people compared to other marital statuses.

## Outliers

Can only check continuous variables, hence only `age`.

```{r outlier plots}
ggplot(data, aes(age)) +
  geom_boxplot()
```
No outliers using IQR.

## Relations

```{r correlation plots}
```


# Missing data problem (Aga)

## Missing data and response Patterns
Firstly, we investigate the overall distribution of missing data in our dataset:

```{r mis_percentage, echo = FALSE}

# Creates a graph displaying the % of data missing in each variable

vis_miss(data)
```

As can be seen on the graph above, 8.2% of the data is missing. The missing values occur in the outcome variable 'drink_regularly' and in the responses to questions 'dep2', 'dep3', 'dep5', 'dep6', 'dep8' and 'dep9' that create the depression score variable. 15% of responses are missing for the predictor variable. 25% of the responses are missing for the individual depression questions 2, 3, 5 and 6, 10% are missing for question 8 and 14% for question 9. 

We further investigate the missing data patterns by looking at the response patters:

```{r res_pattern}

#Creates a graph with all of the response patterns in the dataset and their frequency

md.pattern(data, rotate = TRUE)
```

This figure reveals that there are 13 distinct response patterns in the dataset and the missingness pattern is not monotone. The most frequent pattern is no missing entries, with 263 cases. It is important to note that the depression questions 2, 3, 5 and 6 are always either all present or all missing. It is very probable that the reason for item non-response for the depression items is the same, since there are no cases of only some of them missing. 

Based on the missingness pattern of the depression items, 41% of the overall depression score includes at least one missing value. 

 
#### Testing dependency of missing values

```{r is_mis_vectors}
# Creating vectors that indicate if a value is missing in a given variable. Since the pattern in depression items is the same, one vector is sufficient. 

mdrink <- is.na(data$drink_regularly)
mdep <- is.na(data$dep2)

# Testing dependency between missing value in var1 and values of var2. Null hypothesis: no dependency. 

out1 <- t.test(age ~ mdrink, data = data)
out1$statistic
out1$p.value
```

```{r mcar_test}
# Should this be on data1 or data?
mcar_test(data)
```
Thus, the missing values are definitely not missing at random. 

- what's the missing data mechnism? 

### Result models with deletion and imputation (Nisse)
- formula
- table with coefficients and pval (make sure to exponential the coefficients for easier interpretation)
- Interpretation of model result 

```{r}
miceOut <- mice(data, defaultMethod = c("norm.predict", "logreg", "polyreg", "polr"), m = 1, maxit = 1)
reg_imp_data <- complete(miceOut)
summary(reg_imp_data)
```

## Comparison of the two diffrent models in terms of missing data treatment !!! (Ruben)

## Conclusion in terms of answering RQ (Nisse)


