---
title: "Missing Data - Assignment 1"
author: "Aga, Nisse, Ruben"
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2
---

```{r dependencies, echo=FALSE, message=FALSE}
# Load dependencies.
library(tidyverse)
library(fastDummies)
library(kableExtra)
library(gridExtra, exclude="combine")
library(lubridate)
library(car)
library(ICC)
library(caret)
library(pROC)
library(naniar)
library(ggmice)
library(mice)
library(vtable)
```

```{r functions, echo=FALSE}
show_table <- function(data, caption) {
  kbl(data, caption = caption, booktabs = T) %>%
    kable_styling(latex_options = c(
      "striped", 
      "scale_down", 
      "hold_position",
      "repeat_header"
    ))
}
```

```{r load data, echo=FALSE}
# Read file.
source <- readRDS("../data/data.rds") %>%
  as_tibble()
```

```{r variable selection, echo=FALSE}
# We create a sub-selection of variables that are of interest to our model.
data <- source %>%
  select(
    id,
    drink_regularly, 
    sex, 
    age,
    ethnicity, 
    education, 
    marital, 
    household_income,
    dep1,
    dep2,
    dep3,
    dep4,
    dep5,
    dep6,
    dep7,
    dep8,
    dep9
  )
```

```{r variable table, echo=FALSE}
# Read variable description file.
descs <- read.csv("../data/variables.csv", header = TRUE, sep = ";") %>%
  as_tibble()
```

# Introduction (Ruben)

### RQ (Ruben)

# Methodology (Aga) {#methodology}

## Dataset

The dataset used is a subset of the data collected in the National Health and Nutrition Examination Survey (NHANES). The survey is a part of annual program that investigates the health and nutrition of a representative sample of people in the United States. The data we used contains information about 525 individuals that has been collected for the NHANES 2007-2008. This is a subset of the 12,946 individuals in that years' survey sample, out of which 78.4% was interviewed and 75.4% was examined in mobile examination centers. 

The used dataset contains a wide range of variables related to the health of the individuals. We further subset the data by only including variables relevant to the study (demographics, alcohol use and answers to depression screener questions). The selected variables are further described in Variable Description section.  


## Data variables

```{r, vars-desc, echo=FALSE}
show_table(descs, "Variable descriptions")
```

Table \@ref(tab:vars-desc) lists the variables used in our subset selection, which will be utilised for the model in question. The predictor variables $[dep1...dep9]$ are sourced from the same Depression Screener, where respondents of age 18 to 150 were ought to assign a number (1 to 3) regarding their mental and physical state within the last 2 weeks. 
The demographic variables - that being `sex`, `age`, `ethnicity`, `education` and `household_income` - were taken from the same screening component as well. The following should be noted, regarding these demographic variables:  

- The variable `age` is topcoded at the value `80`  for the respondents who were older than 80 years. 
- The variable `education` was targeted at respondents of age `20` to `150`, thus excluding younger participants. This is due to the fact that this question includes responses such as `AA degree` and `College Graduate`.
- Similarly, the variable `marital` was also targeted at respondents of age `20` to `150`.
- The variable `household_income` is ordinal, rather than continuous.

As for the remaining demographic variables, namely `sex`, `age`, `ethnicity` and `household_income`, these are retrieved from target age `0` to `150`.  

Finally, the `drink_regularly` variable was obtained from an Alcohol Use questionnaire targeted at ages 20 and up.

## Data proccessing methodology

- what we investigated and why  

## Model methodology

# EDA Results (Nisse) {#EDA}

## Descriptive statistics

```{r data-sum, echo=FALSE}
sumtable(data, title = "Summary statistics", fit.page = TRUE)
```

```{r data-calcs, echo=FALSE}
# Calculate frequency per marital category, excluding the dominant category of 'married'.
marital_counts <- data %>%
  select(marital) %>%
  filter(marital != 'married') %>%
  group_by(marital) %>%
  count()
  
# Calculate mean frequency of non-dominant marital categories.
marital_avg <- mean(marital_counts$n)

# Function for marital plotting
plot_marital <- function(data) {
  ggplot(data, aes(marital)) +
    geom_bar(stat = 'count') +
    labs(
      x = 'Marital status',
      y = 'Frequency'
    )
}
```
Table \@ref(tab:data-sum) shows summary statistics for each of the variables within the dataset; including mean values, standard deviations, IQR statistics and data range values. In general, it is worthy to note that all variables are interpreted as a factor, excluding `age` and the multiple depression levels of `dep`. Table \@ref(tab:vars-desc) suggests that `dep` should in fact be categorical ordinal and hence also be cast as a factor. That said - and as mentioned in Section \@ref(methodology) - keeping the levels of `dep` as a numerical continuous datatype is beneficial for our missing data problem.  

Our outcome variable `drink_regularly` has 307 cases of "yes" and 107 cases of "no", having a outcome balance of 69% and 31% respectively. This outcome ratio could be considered imbalanced, which could affect the accuracy of our model. Additionally, the frequencies per case suggest that 79 cases contain values outside of the dichotomous set of possible values - possibly being missing values.

The variable `marital` contains 6 categories. Prior to combining the `marital` categories, the category value `married` exceeded the the average frequency of other categories (that being `r marital_avg`) by a large margin - as can be seen in Figure \@ref(fig:marital-dist-1).

```{r marital-dist-1, fig.cap = "Distribution of marital status categories before pre-processing", echo=FALSE}
plot_marital(data)
```

```{r combine-marital, echo=FALSE}
data <- data %>%
  mutate(marital = case_when(
    marital == 'married' ~ 'married',
    .default = 'other'
  ))
```

Figure \@ref(fig:marital-dist-2) shows the frequencies per `marital` category after the pre-processing step of combining the other values into one.

```{r marital-dist-2, fig.cap = "Distribution of marital status categories after pre-processing", echo=FALSE}
plot_marital(data)
```

```{r data-str, echo=FALSE}
summary(data)
```


Notes:  
- note: age < 20 is missing from data!!  

## Distributions

```{r dist, eval=FALSE}

# Continuous
ggplot(data, aes(age)) + geom_histogram(stat = 'count')

# Categorical
categorical_dist <- function(plot) {
  plot +
    geom_histogram(stat = 'count') +
     theme(axis.text.x = element_blank())
}

ggplot(data, aes(drink_regularly, fill = drink_regularly)) %>% categorical_dist()
ggplot(data, aes(sex, fill = sex)) %>% categorical_dist()
ggplot(data, aes(ethnicity, fill = ethnicity)) %>% categorical_dist()
ggplot(data, aes(education, fill = education)) %>% categorical_dist()
ggplot(data, aes(marital, fill = marital)) %>% categorical_dist()
ggplot(data, aes(household_income, fill = household_income)) %>% categorical_dist()

# TODO depression data

```
Notes:  
- Age is not normally distributed, moreover might be unknowingly missing data < 20 and > 70?  
- Missing data in outcome (and depression).  
- Lots of married people compared to other marital statuses.

## Outliers

Can only check continuous variables, hence only `age`.

```{r outlier plots}
ggplot(data, aes(age)) +
  geom_boxplot()
```
No outliers using IQR.

## Relations

```{r correlation plots}
```


# Missing data problem (Aga)

## Missing data and response Patterns
Firstly, we investigate the overall distribution of missing data in our dataset:

```{r mis_percentage}

# Creates a graph displaying the % of data missing in each variable

vis_miss(data)
```

As can be seen on the graph above, 8.2% of the data is missing. The missing values occur in the outcome variable 'drink_regularly' and in the responses to questions 'dep2', 'dep3', 'dep5' and 'dep6'that create the depression score variable. 15% of responses are missing for the predictor variable and 25% of the responses are missing for the individual depression questions. 

We further investigate the missing data patterns by looking at the response patters:

```{r res_pattern}

#Creates a graph with all of the response patterns in the dataset and their frequency

md.pattern(data, rotate = TRUE)
```

This figure reveals that there are four distinct response patterns in the dataset. The most frequent one is no missing entries, with 340 cases. Alternatively, either all four depression entries are missing (106 cases), the predictor variable is missing (54 cases) or both (25 cases). It is very probable that the reason for item non-response for the depression items is the same, since there are no cases of only some of them missing. Since the depression items are missing in this pattern, 25% of the overall depression score will be missing. 

#### Testing dependency of missing values

```{r is_mis_vectors}
# Creating vectors that indicate if a value is missing in a given variable. Since the pattern in depression items is the same, one vector is sufficient. 

mdrink <- is.na(data$drink_regularly)
mdep <- is.na(data$dep2)

# Testing dependency between missing value in var1 and values of var2. Null hypothesis: no dependency. 

out1 <- t.test(age ~ mdrink, data = data)
out1$statistic
out1$p.value
```

```{r mcar_test}
# Should this be on data1 or data?
mcar_test(data)
```
Thus, the missing values are definitely not missing at random. 

- what's the missing data mechnism? 

### Result models with deletion and imputation (Nisse)
- formula
- table with coefficients and pval (make sure to exponential the coefficients for easier interpretation)
- Interpretation of model result 

```{r}
miceOut <- mice(data, defaultMethod = c("norm.predict", "logreg", "polyreg", "polr"), m = 1, maxit = 1)
reg_imp_data <- complete(miceOut)
summary(reg_imp_data)
```

## Comparison of the two diffrent models in terms of missing data treatment !!! (Ruben)

## Conclusion in terms of answering RQ (Nisse)


